<html>
	<head>
        <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
        <!--<script src='https://cdn.staticaly.com/gh/robertklep/homey-mocks/v0.0.4/homey-settings-mock.js'></script>-->
        <link rel="stylesheet" href="css/bootstrap.min.css">
	</head>
	<body>
        <h1>Connection Settings</h1>
		<fieldset>
            <div class="container">
                <div class="alert alert-danger" role="alert" id="apiError" style="display: none">
                    <div class="ApiErrorShow">Error!</div>
                </div>
                <div class="row col-9">
                    <div class="col-sm mt-4">
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" style="height: 35" id="discoverButton">Discover & Authenticate</button>
                        </div>
                    </div>
                    <div class="col-sm mt-4">
                        <div class="form-group">
                            <button type="button" class="btn btn-outline-secondary" style="height: 35" id="advancedSettingsButton">Show Advanced</button>
                        </div>
                    </div>
                </div>
                <div class="row col-9" class="collapse" id="advancedsettings" style="display: none;">
                    <div class="col-sm">
                        <div class="form-group">
                            <label>deCONZ IP/hostname</label>
                            <input type="text" class="form-control" id="deconzIPAdress" placeholder="xxx.xxx.xxx.xxx">
                            <small id="ipHelp" class="form-text text-muted">IP address of the deCONZ/phoscon gateway</small>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="form-group">
                            <label>api-interface port</label>
                            <input type="number" class="form-control" id="deconzPort" placeholder="xx">
                            <small id="ipHelp" class="form-text text-muted">Port is needed to get an API key automatically</small>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="form-group">
                            <label>websocket port</label>
                            <input type="number" class="form-control" id="wsPort" placeholder="xxxx">
                            <small id="ipHelp" class="form-text text-muted">WS port is needed to subscribe for realtime updates</small>
                        </div>
                    </div>
                    <div class="col-sm">
                        <div class="form-group">
                            <label>API key</label>
                            <input type="text" class="form-control" id="apiKey">
                        </div>
                    </div>
                    <div class="row col-9">
                        <div class="col-sm mt-4">
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" style="height: 35" id="createButton">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
		</fieldset>

        <script type="text/javascript">
            //document.addEventListener("DOMContentLoaded", function(event) { 
            function onHomeyReady(Homey) {
                const ip = document.getElementById('deconzIPAdress')
                const port = document.getElementById('deconzPort')
                const apiKey = document.getElementById('apiKey')
                const wsPort = document.getElementById('wsPort')
                const saveButton = document.getElementById('createButton')
                const discoverButton = document.getElementById('discoverButton')
                const advancedSettingsButton = document.getElementById('advancedSettingsButton')
                const advancedsettings = document.getElementById('advancedsettings')
                const apiError = document.getElementById('apiError')
                const title = document.getElementsByClassName('ApiErrorShow')[0]
                
                function discover(callback) {
                    apiError.style.display = 'grid'
                    apiError.classList.remove('alert-danger')
                    apiError.classList.add('alert-success')
                    title.innerHTML = 'Autodiscovering...'
                    const url = 'http://phoscon.de/discover'
                    const xhr = new XMLHttpRequest()
                    xhr.onreadystatechange = function (e) {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            const response = JSON.parse(xhr.responseText)[0]
                            if (Object.keys(response).length === 0) {
                                apiError.style.display = 'grid'
                                apiError.classList.remove('alert-success')
                                apiError.classList.add('alert-danger')
                                apiKey.value = ''
                                title.innerHTML = "Can't autodiscover deCONZ gateway on your network"
                                callback(new Error('Empty array in response'))
                            } else {
                                apiError.style.display = 'grid'
                                apiError.classList.remove('alert-danger')
                                apiError.classList.add('alert-success')
                                title.innerHTML = 'Successfully autodiscovered gateway'
                                callback(null, {
                                    ip: response.internalipaddress,
                                    port: response.internalport
                                })
                            }
                        }
                    }
                    xhr.open('GET', url, true)
                    xhr.send()
                }

                function getAPIkey(callback) {
                    const url = `http://${ip.value}:${port.value}/api`
                    const data = JSON.stringify({
                        "devicetype": "homeyCONZ"
                    })
                    const xhr = new XMLHttpRequest()
                    xhr.open('POST', url, true)
                    xhr.setRequestHeader('Content-Type', 'application/json')
                    xhr.onreadystatechange = function() {
                        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                            const response = JSON.parse(xhr.responseText)
                            callback(null, response[0].success.username)
                        } else if (this.readyState === XMLHttpRequest.DONE && this.status === 403) {
                            const response = JSON.parse(xhr.responseText)
                            callback(new Error('Please go to settings→gateway→advanced and click on authenticate in the phoscon app and try again!'))
                        }else{
                            const response = JSON.parse(xhr.responseText)
                            callback(new Error(response[0].error.description), null)
                        }
                    }
                    xhr.send(data)
                }

                function getWSport(callback) {
                    if (wsPort.value != "") {
                        callback(wsPort.value)
                        return
                    }
                    const url = `http://${ip.value}:${port.value}/api/${apiKey.value}/config`
                    const xhr = new XMLHttpRequest()
                    xhr.onreadystatechange = function (e) {
                        if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
                            const response = JSON.parse(xhr.responseText)                            
                            callback(null, response.websocketport)
                        }else  if (this.readyState === XMLHttpRequest.DONE) {
                            callback(new Error('Error while fetching the WS port'), null)
                        }
                    }
                    xhr.open('GET', url, true)
                    xhr.send()
                }
                
                advancedSettingsButton.addEventListener('click', (e) => {
                    if (advancedsettings.style.display === "none") {
                        advancedsettings.style.display = "block";
                        advancedSettingsButton.innerHTML = 'Hide Advanced'
                    } else {
                        advancedsettings.style.display = "none";
                        advancedSettingsButton.innerHTML = 'Show Advanced'
                    }
                })

                saveButton.addEventListener('click', (e) => {
                    if (!ip.value) {
                        apiError.style.display = 'grid'
                        apiError.classList.remove('alert-success')
                        apiError.classList.add('alert-danger')
                        title.innerHTML = 'Enter IP address'
                    } else if (!port.value) {
                        apiError.style.display = 'grid'
                        apiError.classList.remove('alert-success')
                        apiError.classList.add('alert-danger')
                        title.innerHTML = 'Enter port'
                    } else if (!apiKey.value) {
                        apiError.style.display = 'grid'
                        apiError.classList.remove('alert-success')
                        apiError.classList.add('alert-danger')
                        title.innerHTML = 'Enter api key'
                    } else if (!wsPort.value) {
                        apiError.style.display = 'grid'
                        apiError.classList.remove('alert-success')
                        apiError.classList.add('alert-danger')
                        title.innerHTML = 'Enter WS port'
                    } else {
                        saveAll()
                        apiError.style.display = 'grid'
                        apiError.classList.remove('alert-danger')
                        apiError.classList.add('alert-success')
                        title.innerHTML = 'Successfuly saved!'
                        Homey.alert(`succesfully saved`)
                    }
                })
                
                discoverButton.addEventListener('click', (e) => {
                    ip.value = ''
                    port.value = ''
                    wsPort.value = ''
                    apiKey.value = ''
                    discover((error, data) => {
                        ip.value = data.ip
                        port.value = data.port
                            getAPIkey(function(error, success) {
                                if (!!error) {
                                    apiError.style.display = 'grid'
                                    apiError.classList.remove('alert-success')
                                    apiError.classList.add('alert-danger')
                                    title.innerHTML = error.message
                                    return
                                }
                                apiKey.value = success;
                                getWSport(function(error, success){
                                    if (!!error) {
                                        apiError.style.display = 'grid'
                                        apiError.classList.remove('alert-success')
                                        apiError.classList.add('alert-danger')
                                        title.innerHTML = error.message
                                        return
                                    }
                                    wsPort.value = success
                                    saveAll()

                                    apiError.style.display = 'grid'
                                    apiError.classList.remove('alert-danger')
                                    apiError.classList.add('alert-success')
                                    title.innerHTML = 'Successfuly initialized and saved!'
                                    Homey.alert(`succesfully saved`)
                                })
                            })
                    })
                })
                
                function saveAll() {
                    Homey.set('host', ip.value, (err, settings) => {
                        if (err) return Homey.alert(err)
                    })
                    Homey.set('port', port.value, (err, settings) => {
                        if (err) return Homey.alert(err)
                    })
                    Homey.set('wsport', wsPort.value, (err, settings) => {
                        if (err) return Homey.alert(err)
                    })
                    Homey.set('apikey', apiKey.value, (err, settings) => {
                        if (err) return Homey.alert(err)
                    })
                }

                Homey.get('host', (err, host) => {
                    if (err) return Homey.alert(err)
                    ip.value = host
                })
                
                Homey.get('port', (err, storedPort) => {
                    if (err) return Homey.alert(err)
                    port.value = storedPort
                })

                Homey.get('wsport', (err, storedWSPort) => {
                    if (err) return Homey.alert(err)
                    wsPort.value = storedWSPort
                })
                
                Homey.get('apikey', (err, apikey) => {
                    if (err) return Homey.alert(err)
                    apiKey.value = apikey
                })

                Homey.ready()
            }

            //);
            
        </script>
	</body>
</html>